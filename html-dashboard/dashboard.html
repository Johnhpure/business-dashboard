<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拼好拼 - 业务数据看板</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/animations.css">
    <!-- ECharts 图表库 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- 字体图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <!-- 动态背景 -->
    <div class="background-animation">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <!-- 主容器 -->
    <div class="dashboard-container">
        <!-- 顶部导航栏 -->
        <header class="dashboard-header glass-card">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-chart-line"></i>
                    <span>拼好拼数据看板</span>
                </div>
            </div>
            <div class="header-center">
                <!-- 分红轮次展示 -->
                <div class="round-display-header">
                    <div class="round-info-card">
                        <div class="round-number-display">
                            <span class="round-label">当前分红为：</span>
                            <span class="round-current" id="totalDividendCount">第24次</span>
                        </div>
                        <div class="round-number-display">
                            <span class="round-label-secondary">最新分红轮次：</span>
                            <span class="round-current">第25轮</span>
                            <span class="round-status-badge">进行中</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span>管理员</span>
                </div>
            </div>
        </header>

        <!-- 主内容区域 -->
        <main class="dashboard-main">
            <!-- 内容区域 (移除了左侧筛选面板) -->
            <div class="content-area full-width">
                <!-- KPI概览区域 -->
                <section class="kpi-overview">
                    <div class="kpi-grid">
                        <div class="kpi-card glass-card" data-kpi="revenue">
                            <div class="kpi-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">
                                    <span class="number">0</span>
                                    <span class="unit">元</span>
                                </div>
                                <div class="kpi-label">总交易金额</div>
                                <div class="kpi-trend positive">
                                    <span>今日新增：</span>
                                    <span class="trend-value">1,986,000</span>
                                    <span class="trend-unit">元</span>
                                </div>
                            </div>
                        </div>

                        <div class="kpi-card glass-card" data-kpi="stores">
                            <div class="kpi-icon">
                                <i class="fas fa-store"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">
                                    <span class="number">0</span>
                                    <span class="unit">家</span>
                                </div>
                                <div class="kpi-label">活跃商户</div>
                                <div class="kpi-trend positive">
                                    <span>今日新增：</span>
                                    <span class="trend-value">127</span>
                                    <span class="trend-unit">家</span>
                                </div>
                            </div>
                        </div>

                        <div class="kpi-card glass-card" data-kpi="users">
                            <div class="kpi-icon">
                                <i class="fas fa-user-friends"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">
                                    <span class="number">0</span>
                                    <span class="unit">人</span>
                                </div>
                                <div class="kpi-label">活跃用户</div>
                                <div class="kpi-trend positive">
                                    <span>今日新增：</span>
                                    <span class="trend-value">3,724</span>
                                    <span class="trend-unit">人</span>
                                </div>
                            </div>
                        </div>

                        <div class="kpi-card glass-card" data-kpi="business">
                            <div class="kpi-icon">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">
                                    <span class="number">0</span>
                                    <span class="unit">人</span>
                                </div>
                                <div class="kpi-label">认证商务</div>
                                <div class="kpi-trend positive">
                                    <span>今日新增：</span>
                                    <span class="trend-value">89</span>
                                    <span class="trend-unit">人</span>
                                </div>
                            </div>
                        </div>

                        <div class="kpi-card glass-card" data-kpi="dividend">
                            <div class="kpi-icon">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">
                                    <span class="number">0</span>
                                    <span class="unit">元</span>
                                </div>
                                <div class="kpi-label">当前分红池总金额</div>
                                <div class="kpi-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: 73%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 新增业务数据概览区域 -->
                <section class="business-overview">
                    <div class="business-grid">
                        <div class="kpi-card glass-card" data-kpi="points-issued">
                            <div class="kpi-icon">
                                <i class="fas fa-gift"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">
                                    <span class="number">0</span>
                                    <span class="unit">点</span>
                                </div>
                                <div class="kpi-label">消费点发放</div>
                                <div class="kpi-trend positive">
                                    <span>今日发放：</span>
                                    <span class="trend-value">125,680</span>
                                    <span class="trend-unit">点</span>
                                </div>
                            </div>
                        </div>

                        <div class="kpi-card glass-card" data-kpi="voucher-consumed">
                            <div class="kpi-icon">
                                <i class="fas fa-ticket-alt"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">
                                    <span class="number">0</span>
                                    <span class="unit">元</span>
                                </div>
                                <div class="kpi-label">抵用券消费</div>
                                <div class="kpi-trend positive">
                                    <span>今日消费：</span>
                                    <span class="trend-value">89,420</span>
                                    <span class="trend-unit">元</span>
                                </div>
                            </div>
                        </div>

                        <div class="kpi-card glass-card" data-kpi="good-points-consumed">
                            <div class="kpi-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">
                                    <span class="number">0</span>
                                    <span class="unit">点</span>
                                </div>
                                <div class="kpi-label">好点消费</div>
                                <div class="kpi-trend positive">
                                    <span>今日消费：</span>
                                    <span class="trend-value">67,890</span>
                                    <span class="trend-unit">点</span>
                                </div>
                            </div>
                        </div>

                        <div class="kpi-card glass-card" data-kpi="voucher-withdrawal">
                            <div class="kpi-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">
                                    <span class="number">0</span>
                                    <span class="unit">元</span>
                                </div>
                                <div class="kpi-label">抵用券提现</div>
                                <div class="kpi-trend positive">
                                    <span>今日提现：</span>
                                    <span class="trend-value">45,230</span>
                                    <span class="trend-unit">元</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 地图和图表区域 -->
                <section class="visualization-section">
                    <div class="viz-grid">
                        <!-- 全国业绩流水概览 -->
                        <div class="map-container glass-card">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-pie"></i> 全国业绩流水概览（当日）</h3>
                                <div class="card-controls">
                                    <button class="control-btn active" data-map-type="revenue">
                                        <i class="fas fa-dollar-sign"></i> 收入
                                    </button>
                                    <button class="control-btn" data-map-type="stores">
                                        <i class="fas fa-store"></i> 商户
                                    </button>
                                    <button class="control-btn" data-map-type="users">
                                        <i class="fas fa-users"></i> 用户
                                    </button>
                                </div>
                            </div>
                            <div class="national-overview-content">
                                <div class="provinces-list">
                                    <div class="provinces-summary" id="provincesList">
                                        <!-- 省份列表将通过JavaScript动态生成 -->
                                    </div>
                                </div>
                                <div class="overview-chart">
                                    <div class="map-chart" id="chinaMap"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 分红卡片容器 -->
                        <div class="dividend-cards-container">
                            <!-- 当前分红轮次详情 -->
                            <div class="dividend-details glass-card compact-card">
                                <div class="card-header">
                                    <h3><i class="fas fa-coins"></i> 第25次分红详情</h3>
                                </div>
                                <div class="dividend-details-content">
                                    <div class="dividend-grid">
                                        <div class="dividend-row">
                                            <div class="dividend-item">
                                                <div class="dividend-icon store-icon">
                                                    <i class="fas fa-store"></i>
                                                </div>
                                                <div class="dividend-info">
                                                    <div class="dividend-label">商户分红</div>
                                                    <div class="dividend-value">¥136,000</div>
                                                </div>
                                            </div>
                                            <div class="dividend-item">
                                                <div class="dividend-icon user-icon">
                                                    <i class="fas fa-users"></i>
                                                </div>
                                                <div class="dividend-info">
                                                    <div class="dividend-label">用户分红</div>
                                                    <div class="dividend-value">¥102,000</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dividend-item total-item">
                                            <div class="dividend-icon total-icon">
                                                <i class="fas fa-calculator"></i>
                                            </div>
                                            <div class="dividend-info">
                                                <div class="dividend-label">预估总额</div>
                                                <div class="dividend-value highlight">¥680,000</div>
                                            </div>
                                        </div>
                                        <div class="dividend-item countdown-item">
                                            <div class="dividend-icon countdown-icon">
                                                <i class="fas fa-clock"></i>
                                            </div>
                                            <div class="dividend-info">
                                                <div class="dividend-label">距下轮分红倒计时</div>
                                                <div class="dividend-value countdown">24h</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 分红历史记录 -->
                            <div class="dividend-history glass-card compact-card">
                                <div class="card-header">
                                    <h3><i class="fas fa-history"></i> 第24轮分红详情</h3>
                                </div>
                                <div class="dividend-history-content">
                                    <div class="dividend-grid">
                                        <div class="dividend-row">
                                            <div class="dividend-item">
                                                <div class="dividend-icon partner-icon">
                                                    <i class="fas fa-handshake"></i>
                                                </div>
                                                <div class="dividend-info">
                                                    <div class="dividend-label">合伙人分红</div>
                                                    <div class="dividend-value">¥272,000</div>
                                                </div>
                                            </div>
                                            <div class="dividend-item">
                                                <div class="dividend-icon business-icon">
                                                    <i class="fas fa-user-tie"></i>
                                                </div>
                                                <div class="dividend-info">
                                                    <div class="dividend-label">商务分红</div>
                                                    <div class="dividend-value">¥170,000</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dividend-item total-item">
                                            <div class="dividend-icon total-icon">
                                                <i class="fas fa-calculator"></i>
                                            </div>
                                            <div class="dividend-info">
                                                <div class="dividend-label">预估总额</div>
                                                <div class="dividend-value highlight">¥650,000</div>
                                            </div>
                                        </div>
                                        <div class="dividend-item countdown-item">
                                            <div class="dividend-icon countdown-icon">
                                                <i class="fas fa-clock"></i>
                                            </div>
                                            <div class="dividend-info">
                                                <div class="dividend-label">距下轮分红倒计时</div>
                                                <div class="dividend-value countdown">24h</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 图表分析区域 -->
                <section class="charts-section">
                    <div class="charts-grid">
                        <!-- 收入趋势图 -->
                        <div class="chart-container glass-card">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-line"></i> 收入趋势分析</h3>
                                <div class="chart-controls">
                                    <button class="control-btn active" data-period="week">周</button>
                                    <button class="control-btn" data-period="month">月</button>
                                    <button class="control-btn" data-period="year">年</button>
                                </div>
                            </div>
                            <div class="chart" id="revenueChart"></div>
                        </div>

                        <div class="chart-container glass-card">
                            <div class="card-header">
                                <h3><i class="fas fa-coins"></i> 分红轮次趋势分析</h3>
                            </div>
                            <div class="chart" id="dividendRoundChart"></div>
                        </div>

                        <div class="chart-container glass-card">
                            <div class="card-header">
                                <h3><i class="fas fa-history"></i> 分红次数趋势分析</h3>
                            </div>
                            <div class="chart" id="dividendCountChart"></div>
                        </div>

                    </div>
                </section>

                <!-- 排行榜区域 -->
                <section class="ranking-section">
                    <div class="ranking-grid">
                        <!-- 商户收益排行 -->
                        <div class="ranking-card glass-card">
                            <div class="card-header">
                                <h3><i class="fas fa-medal"></i> 商户收益排行</h3>
                                <div class="ranking-controls">
                                    <select class="glass-select small">
                                        <option value="month">本月</option>
                                        <option value="quarter">本季度</option>
                                        <option value="year">本年</option>
                                    </select>
                                </div>
                            </div>
                            <div class="ranking-list" id="storeRanking">
                                <!-- 排行榜内容将通过JavaScript动态生成 -->
                            </div>
                        </div>

                        <!-- 商务进件排行榜 -->
                        <div class="ranking-card glass-card">
                            <div class="card-header">
                                <h3><i class="fas fa-trophy"></i> 商务进件排行榜</h3>
                                <div class="ranking-controls">
                                    <select class="glass-select small">
                                        <option value="month">本月</option>
                                        <option value="quarter">本季度</option>
                                        <option value="year">本年</option>
                                    </select>
                                </div>
                            </div>
                            <div class="ranking-list" id="businessRanking">
                                <!-- 排行榜内容将通过JavaScript动态生成 -->
                            </div>
                        </div>

                        <!-- 用户消费排行榜 -->
                        <div class="ranking-card glass-card">
                            <div class="card-header">
                                <h3><i class="fas fa-shopping-cart"></i> 用户消费排行榜</h3>
                                <div class="ranking-controls">
                                    <select class="glass-select small" id="userConsumptionPeriod">
                                        <option value="day" selected>本日</option>
                                        <option value="month">本月</option>
                                        <option value="year">本年</option>
                                    </select>
                                </div>
                            </div>
                            <div class="ranking-list" id="userConsumptionRanking">
                                <!-- 排行榜内容将通过JavaScript动态生成 -->
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- JavaScript 内联版本 - 解决CORS问题 -->
    <script>
        console.log('开始初始化数据看板...');

        // 数据管理类
        class DataManager {
            constructor() {
                this.mockData = {
                    overview: {
                        revenue: { value: 12580000, todayNew: { value: 1986000, unit: '元' } },
                        stores: { value: 8642, todayNew: { value: 127, unit: '家' } },
                        users: { value: 156789, todayNew: { value: 3724, unit: '人' } },
                        business: { value: 2847, todayNew: { value: 89, unit: '人' } },
                        dividend: { value: 2516000, todayNew: { value: 312000, unit: '元' } }
                    },
                    business: {
                        pointsIssued: { value: 2856780, todayNew: { value: 125680, unit: '点' } },
                        voucherConsumed: { value: 1456890, todayNew: { value: 89420, unit: '元' } },
                        goodPointsConsumed: { value: 987650, todayNew: { value: 67890, unit: '点' } },
                        voucherWithdrawal: { value: 756430, todayNew: { value: 45230, unit: '元' } }
                    },
                    dividend: {
                        currentRound: 25,
                        progress: 73,
                        estimatedTime: '2天后',
                        estimatedAmount: 680000,
                        distribution: [
                            { role: '合伙人', amount: 272000, percentage: 40 },
                            { role: '商务', amount: 170000, percentage: 25 },
                            { role: '商户', amount: 136000, percentage: 20 },
                            { role: '用户', amount: 102000, percentage: 15 }
                        ]
                    },
                    rankings: {
                        business: [
                            { name: '张伟', region: '四川省', count: 156, amount: 0, change: 18.5 },
                            { name: '李明', region: '广东省', count: 142, amount: 0, change: 15.2 },
                            { name: '王强', region: '北京市', count: 138, amount: 0, change: 22.1 },
                            { name: '刘芳', region: '上海市', count: 125, amount: 0, change: 12.8 },
                            { name: '陈杰', region: '浙江省', count: 118, amount: 0, change: 16.3 },
                            { name: '赵敏', region: '江苏省', count: 112, amount: 0, change: 9.7 },
                            { name: '孙丽', region: '山东省', count: 108, amount: 0, change: 14.6 },
                            { name: '周涛', region: '河南省', count: 95, amount: 0, change: 11.2 },
                            { name: '吴华', region: '湖北省', count: 89, amount: 0, change: 8.9 },
                            { name: '郑磊', region: '福建省', count: 82, amount: 0, change: 13.4 }
                        ],
                        userConsumption: [
                            { name: '王小明', region: '四川省-成都市', amount: 2580 },
                            { name: '李小红', region: '广东省-深圳市', amount: 2340 },
                            { name: '张小华', region: '北京市-朝阳区', amount: 2180 },
                            { name: '刘小丽', region: '上海市-浦东新区', amount: 1950 },
                            { name: '陈小军', region: '浙江省-杭州市', amount: 1820 },
                            { name: '赵小敏', region: '江苏省-南京市', amount: 1680 },
                            { name: '孙小强', region: '山东省-青岛市', amount: 1540 },
                            { name: '周小芳', region: '河南省-郑州市', amount: 1420 },
                            { name: '吴小涛', region: '湖北省-武汉市', amount: 1320 },
                            { name: '郑小磊', region: '福建省-厦门市', amount: 1180 }
                        ],
                        stores: [
                            { name: '老王餐厅', location: '四川省-成都市', stores: 1, amount: 125000, change: 25.6 },
                            { name: '小李超市', location: '广东省-深圳市', stores: 1, amount: 98000, change: 18.9 },
                            { name: '阿华理发店', location: '北京市-朝阳区', stores: 1, amount: 76000, change: 22.1 },
                            { name: '美味咖啡厅', location: '上海市-浦东新区', stores: 1, amount: 65000, change: 14.3 },
                            { name: '时尚服装店', location: '浙江省-杭州市', stores: 1, amount: 58000, change: 16.8 },
                            { name: '新华书店', location: '江苏省-南京市', stores: 1, amount: 52000, change: 19.2 },
                            { name: '健身中心', location: '山东省-青岛市', stores: 1, amount: 48000, change: 21.7 },
                            { name: '药店连锁', location: '河南省-郑州市', stores: 1, amount: 45000, change: 13.8 },
                            { name: '汽车维修', location: '湖北省-武汉市', stores: 1, amount: 42000, change: 17.5 },
                            { name: '便利店', location: '福建省-厦门市', stores: 1, amount: 38000, change: 15.3 }
                        ]
                    }
                };
            }

            async getData() {
                // 模拟API延迟
                await new Promise(resolve => setTimeout(resolve, 500));
                return this.mockData;
            }
        }

        // 动画管理类
        class AnimationManager {
            animateNumber(element, start, end, duration = 2000) {
                if (!element) return;

                const startTime = performance.now();
                const difference = end - start;

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const easedProgress = this.easeOutCubic(progress);

                    const currentValue = Math.floor(start + difference * easedProgress);
                    element.textContent = this.formatNumber(currentValue);

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        element.textContent = this.formatNumber(end);
                    }
                };

                requestAnimationFrame(animate);
            }

            formatNumber(num) {
                if (num >= 10000) {
                    return (num / 10000).toFixed(1) + 'w';
                }
                return num.toLocaleString();
            }

            easeOutCubic(t) {
                return (--t) * t * t + 1;
            }
        }

        // 图表管理类
        class ChartManager {
            constructor() {
                this.charts = new Map();
            }

            init() {
                this.initChinaMap();
                this.initRevenueChart();
                this.initDividendRoundChart();
                this.initDividendCountChart();
            }

            initChinaMap() {
                const mapContainer = document.getElementById('chinaMap');
                if (!mapContainer || !window.echarts) return;

                const chart = echarts.init(mapContainer);

                // 全国所有省份数据
                const allProvinceData = [
                    { value: 1248000, name: '广东省' },
                    { value: 1156000, name: '江苏省' },
                    { value: 1048000, name: '四川省' },
                    { value: 986000, name: '山东省' },
                    { value: 892000, name: '浙江省' },
                    { value: 735000, name: '河南省' },
                    { value: 680000, name: '湖北省' },
                    { value: 625000, name: '福建省' },
                    { value: 580000, name: '北京市' },
                    { value: 542000, name: '湖南省' },
                    { value: 498000, name: '安徽省' },
                    { value: 484000, name: '上海市' },
                    { value: 456000, name: '河北省' },
                    { value: 425000, name: '陕西省' },
                    { value: 398000, name: '江西省' },
                    { value: 365000, name: '重庆市' },
                    { value: 342000, name: '辽宁省' },
                    { value: 318000, name: '广西壮族自治区' },
                    { value: 295000, name: '云南省' },
                    { value: 276000, name: '山西省' },
                    { value: 258000, name: '贵州省' },
                    { value: 235000, name: '天津市' },
                    { value: 218000, name: '黑龙江省' },
                    { value: 198000, name: '吉林省' },
                    { value: 185000, name: '甘肃省' },
                    { value: 168000, name: '内蒙古自治区' },
                    { value: 145000, name: '新疆维吾尔自治区' },
                    { value: 128000, name: '海南省' },
                    { value: 115000, name: '宁夏回族自治区' },
                    { value: 98000, name: '青海省' },
                    { value: 85000, name: '西藏自治区' }
                ];

                // 饼图只显示前10名
                const topTenProvinceData = allProvinceData.slice(0, 10);

                // 更新省份列表（显示所有省份）
                this.updateProvincesList(allProvinceData);

                // 饼图配置 - 放大饼图
                const option = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderColor: 'rgba(0, 212, 255, 0.5)',
                        textStyle: { color: '#ffffff' },
                        formatter: function (params) {
                            return `${params.name}<br/>业绩流水: ¥${params.value.toLocaleString()}<br/>占比: ${params.percent}%`;
                        }
                    },
                    series: [{
                        name: '全国业绩流水',
                        type: 'pie',
                        radius: ['10%', '85%'], // 调整饼图大小以适应容器
                        center: ['50%', '50%'],
                        data: topTenProvinceData,
                        itemStyle: {
                            borderRadius: 4,
                            borderColor: 'rgba(0, 0, 0, 0.2)',
                            borderWidth: 1
                        },
                        label: {
                            show: true,
                            position: 'outside',
                            formatter: function (params) {
                                // 显示所有省份的标签
                                if (params.value >= 500000) {
                                    return `${params.name}\n¥${(params.value / 10000).toFixed(0)}万`;
                                } else if (params.value >= 200000) {
                                    return `${params.name}\n${(params.value / 10000).toFixed(0)}万`;
                                } else {
                                    return params.name;
                                }
                            },
                            color: '#ffffff',
                            fontSize: 12, // 适中的字体大小
                            fontWeight: 600, // 适中的字体粗细
                            distanceToLabelLine: 8 // 适中的标签距离
                        },
                        labelLine: {
                            show: true,
                            length: 25, // 适中的第一段线长度
                            length2: 15, // 适中的第二段线长度
                            lineStyle: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                width: 1.5
                            }
                        },
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 212, 255, 0.5)'
                            }
                        }
                    }],
                    color: [
                        '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe',
                        '#43e97b', '#38f9d7', '#ffecd2', '#fcb69f', '#a8edea', '#fed6e3',
                        '#ff9a9e', '#fecfef', '#ffecd2', '#fcb69f', '#667eea', '#764ba2',
                        '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                        '#ffecd2', '#fcb69f', '#a8edea', '#fed6e3', '#ff9a9e', '#fecfef',
                        '#667eea', '#764ba2', '#f093fb', '#f5576c'
                    ]
                };

                chart.setOption(option);
                this.charts.set('chinaMap', chart);

                // 添加点击事件
                chart.on('click', (params) => {
                    this.highlightProvince(params.name);
                });
            }

            updateProvincesList(provinceData) {
                const provincesList = document.getElementById('provincesList');
                if (!provincesList) return;

                provincesList.innerHTML = '';

                provinceData.forEach((province, index) => {
                    const provinceItem = document.createElement('div');
                    provinceItem.className = 'summary-item';
                    provinceItem.dataset.province = province.name;

                    provinceItem.innerHTML = `
                        <span class="label">${province.name}</span>
                        <span class="value">¥${(province.value / 10000).toFixed(0)}万</span>
                    `;

                    provinceItem.addEventListener('click', () => {
                        this.highlightProvince(province.name);
                    });

                    provincesList.appendChild(provinceItem);
                });
            }

            highlightProvince(provinceName) {
                // 高亮选中的省份
                const provinceItems = document.querySelectorAll('.summary-item[data-province]');
                provinceItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.province === provinceName) {
                        item.classList.add('active');
                        item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                });

                // 在图表中高亮对应扇形
                const chart = this.charts.get('chinaMap');
                if (chart) {
                    chart.dispatchAction({
                        type: 'highlight',
                        name: provinceName
                    });
                }
            }

            initRevenueChart() {
                const chartContainer = document.getElementById('revenueChart');
                if (!chartContainer || !window.echarts) return;

                const chart = echarts.init(chartContainer);

                // 生成最近7天的数据
                const dates = [];
                const revenues = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    dates.push(`${date.getMonth() + 1}/${date.getDate()}`);
                    revenues.push(Math.floor(Math.random() * 100000) + 50000);
                }

                const option = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderColor: 'rgba(0, 212, 255, 0.5)',
                        textStyle: { color: '#ffffff' }
                    },
                    grid: {
                        left: '3%', right: '4%', bottom: '3%', containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: dates,
                        axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                        axisLabel: { color: '#b8c5d6' }
                    },
                    yAxis: {
                        type: 'value',
                        axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                        axisLabel: { 
                            color: '#b8c5d6',
                            formatter: function(value) {
                                const result = (value / 10000).toFixed(2);
                                return result === '0.00' ? '¥0' : '¥' + result + 'w';
                            }
                        },
                        splitLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.05)' } }
                    },
                    series: [{
                        name: '收入',
                        type: 'line',
                        smooth: true,
                        data: revenues,
                        lineStyle: { width: 3, color: '#667eea' },
                        areaStyle: {
                            color: {
                                type: 'linear', x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(102, 126, 234, 0.3)' },
                                    { offset: 1, color: 'rgba(118, 75, 162, 0.1)' }
                                ]
                            }
                        },
                        symbol: 'circle',
                        symbolSize: 6,
                        itemStyle: { color: '#667eea', borderColor: '#ffffff', borderWidth: 2 },
                        label: {
                            show: true,
                            position: 'top',
                            color: '#b8c5d6',
                            fontSize: 12,
                            formatter: function(params) {
                                const result = (params.value / 10000).toFixed(2);
                                return result === '0.00' ? '¥0' : '¥' + result + 'w';
                            }
                        }
                    }]
                };

                chart.setOption(option);
                this.charts.set('revenueChart', chart);
            }

            initDividendRoundChart() {
                const chartContainer = document.getElementById('dividendRoundChart');
                if (!chartContainer || !window.echarts) return;

                const chart = echarts.init(chartContainer);
                const rounds = [];
                const amounts = [];
                for (let i = 16; i <= 25; i++) {
                    rounds.push(`第${i}轮`);
                    amounts.push(Math.floor(Math.random() * 200000) + 500000);
                }

                const option = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderColor: 'rgba(0, 212, 255, 0.5)',
                        textStyle: { color: '#ffffff' },
                        formatter: function(params) {
                            return `${params[0].name}<br/>分红金额: ¥${params[0].value.toLocaleString()}`;
                        }
                    },
                    grid: {
                        left: '3%', right: '4%', bottom: '3%', containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: rounds,
                        axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                        axisLabel: { color: '#b8c5d6', rotate: 45 }
                    },
                    yAxis: {
                        type: 'value',
                        axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                        axisLabel: { 
                            color: '#b8c5d6',
                            formatter: function(value) {
                                const result = (value / 10000).toFixed(2);
                                return result === '0.00' ? '¥0' : '¥' + result + 'w';
                            }
                        },
                        splitLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.05)' } }
                    },
                    series: [{
                        name: '分红金额',
                        type: 'line',
                        smooth: true,
                        data: amounts,
                        lineStyle: { width: 3, color: '#f093fb' },
                        areaStyle: {
                            color: {
                                type: 'linear', x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(240, 147, 251, 0.3)' },
                                    { offset: 1, color: 'rgba(245, 87, 108, 0.1)' }
                                ]
                            }
                        },
                        symbol: 'circle',
                        symbolSize: 6,
                        itemStyle: { color: '#f093fb', borderColor: '#ffffff', borderWidth: 2 },
                        label: {
                            show: true,
                            position: 'top',
                            color: '#b8c5d6',
                            fontSize: 11,
                            formatter: function(params) {
                                const result = (params.value / 10000).toFixed(2);
                                return result === '0.00' ? '¥0' : '¥' + result + 'w';
                            }
                        }
                    }]
                };

                chart.setOption(option);
                this.charts.set('dividendRoundChart', chart);
            }

            initDividendCountChart() {
                const chartContainer = document.getElementById('dividendCountChart');
                if (!chartContainer || !window.echarts) return;

                const chart = echarts.init(chartContainer);
                const counts = [];
                const amounts = [];
                for (let i = 15; i <= 24; i++) {
                    counts.push(`第${i}次`);
                    amounts.push(Math.floor(Math.random() * 150000) + 450000);
                }

                const option = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderColor: 'rgba(0, 212, 255, 0.5)',
                        textStyle: { color: '#ffffff' },
                        formatter: function(params) {
                            return `${params[0].name}<br/>分红金额: ¥${params[0].value.toLocaleString()}`;
                        }
                    },
                    grid: {
                        left: '3%', right: '4%', bottom: '3%', containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: counts,
                        axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                        axisLabel: { color: '#b8c5d6', rotate: 45 }
                    },
                    yAxis: {
                        type: 'value',
                        axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                        axisLabel: { 
                            color: '#b8c5d6',
                            formatter: function(value) {
                                const result = (value / 10000).toFixed(2);
                                return result === '0.00' ? '¥0' : '¥' + result + 'w';
                            }
                        },
                        splitLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.05)' } }
                    },
                    series: [{
                        name: '分红金额',
                        type: 'line',
                        smooth: true,
                        data: amounts,
                        lineStyle: { width: 3, color: '#43e97b' },
                        areaStyle: {
                            color: {
                                type: 'linear', x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(67, 233, 123, 0.3)' },
                                    { offset: 1, color: 'rgba(56, 249, 215, 0.1)' }
                                ]
                            }
                        },
                        symbol: 'circle',
                        symbolSize: 6,
                        itemStyle: { color: '#43e97b', borderColor: '#ffffff', borderWidth: 2 },
                        label: {
                            show: true,
                            position: 'top',
                            color: '#b8c5d6',
                            fontSize: 11,
                            formatter: function(params) {
                                const result = (params.value / 10000).toFixed(2);
                                return result === '0.00' ? '¥0' : '¥' + result + 'w';
                            }
                        }
                    }]
                };

                chart.setOption(option);
                this.charts.set('dividendCountChart', chart);
            }

        }

        // 主应用类
        class Dashboard {
            constructor() {
                this.dataManager = new DataManager();
                this.animationManager = new AnimationManager();
                this.chartManager = new ChartManager();
                this.init();
            }

            async init() {
                try {
                    console.log('初始化数据看板...');

                    // 绑定事件监听器
                    this.bindEventListeners();

                    // 加载数据
                    await this.loadData();

                    // 初始化图表
                    this.chartManager.init();

                    console.log('数据看板初始化完成');
                } catch (error) {
                    console.error('初始化失败:', error);
                }
            }

            async loadData() {
                try {
                    const data = await this.dataManager.getData();

                    // 更新KPI卡片
                    this.updateKPICards(data.overview);
                    
                    // 更新业务数据卡片
                    this.updateBusinessCards(data.business);

                    // 更新分红轮次详情
                    this.updateDividendDetails(data.dividend);

                    // 更新排行榜
                    this.updateRankings(data.rankings);

                } catch (error) {
                    console.error('数据加载失败:', error);
                }
            }

            updateKPICards(overview) {
                const kpiCards = document.querySelectorAll('.kpi-card');

                kpiCards.forEach(card => {
                    const kpiType = card.dataset.kpi;
                    const numberElement = card.querySelector('.number');
                    const trendValueElement = card.querySelector('.trend-value');
                    const trendUnitElement = card.querySelector('.trend-unit');

                    if (numberElement && overview[kpiType]) {
                        const targetValue = overview[kpiType].value;

                        // 使用动画显示数字
                        this.animationManager.animateNumber(numberElement, 0, targetValue);

                        // 更新今日新增数据
                        if (trendValueElement && overview[kpiType].todayNew) {
                            const todayNewValue = overview[kpiType].todayNew.value;
                            this.animationManager.animateNumber(trendValueElement, 0, todayNewValue);
                        }

                        if (trendUnitElement && overview[kpiType].todayNew) {
                            trendUnitElement.textContent = overview[kpiType].todayNew.unit;
                        }
                    }
                });
            }

            updateBusinessCards(business) {
                const businessCards = document.querySelectorAll('.business-grid .kpi-card');

                businessCards.forEach(card => {
                    const kpiType = card.dataset.kpi;
                    const numberElement = card.querySelector('.number');
                    const trendValueElement = card.querySelector('.trend-value');
                    const trendUnitElement = card.querySelector('.trend-unit');

                    // 映射数据键名
                    let dataKey = '';
                    switch (kpiType) {
                        case 'points-issued':
                            dataKey = 'pointsIssued';
                            break;
                        case 'voucher-consumed':
                            dataKey = 'voucherConsumed';
                            break;
                        case 'good-points-consumed':
                            dataKey = 'goodPointsConsumed';
                            break;
                        case 'voucher-withdrawal':
                            dataKey = 'voucherWithdrawal';
                            break;
                    }

                    if (numberElement && business[dataKey]) {
                        const targetValue = business[dataKey].value;

                        // 使用动画显示数字
                        this.animationManager.animateNumber(numberElement, 0, targetValue);

                        // 更新今日新增数据
                        if (trendValueElement && business[dataKey].todayNew) {
                            const todayNewValue = business[dataKey].todayNew.value;
                            this.animationManager.animateNumber(trendValueElement, 0, todayNewValue);
                        }

                        if (trendUnitElement && business[dataKey].todayNew) {
                            trendUnitElement.textContent = business[dataKey].todayNew.unit;
                        }
                    }
                });
            }

            updateDividendDetails(dividend) {
                // 更新分红摘要信息
                const summaryItems = document.querySelectorAll('.dividend-summary .summary-item');
                summaryItems.forEach(item => {
                    const label = item.querySelector('.label').textContent;
                    const valueElement = item.querySelector('.value');

                    if (label.includes('预计分红时间')) {
                        valueElement.textContent = dividend.estimatedTime;
                    } else if (label.includes('预计分红金额')) {
                        valueElement.textContent = `¥${dividend.estimatedAmount.toLocaleString()}`;
                    } else if (label.includes('当前进度')) {
                        valueElement.textContent = `${dividend.progress}%`;
                    }
                });
            }

            updateRankings(rankings) {
                this.updateRankingList('storeRanking', rankings.stores);
                this.updateRankingList('businessRanking', rankings.business);
                this.updateUserConsumptionRanking(rankings.userConsumption);
            }

            updateRankingList(containerId, data) {
                const container = document.getElementById(containerId);
                if (!container || !data) return;

                container.innerHTML = '';

                data.forEach((item, index) => {
                    const rankingItem = document.createElement('div');
                    rankingItem.className = 'ranking-item';

                    const rankClass = index < 3 ? `top-${index + 1}` : 'other';

                    // 判断是商务进件排行榜还是商户收益排行榜
                    const isBusinessRanking = containerId === 'businessRanking';
                    
                    if (isBusinessRanking) {
                        // 商务进件排行榜：只显示姓名和省份，右侧显示进件数量
                        rankingItem.innerHTML = `
                            <div class="ranking-number ${rankClass}">${index + 1}</div>
                            <div class="ranking-info">
                                <div class="ranking-name">${item.name}</div>
                                <div class="ranking-details">
                                    <span>${item.region}</span>
                                </div>
                            </div>
                            <div class="ranking-value">
                                <div class="ranking-amount">${item.count}件</div>
                            </div>
                        `;
                    } else {
                        // 商户收益排行榜：显示商户名称和省份-城市，右侧只显示金额
                        rankingItem.innerHTML = `
                            <div class="ranking-number ${rankClass}">${index + 1}</div>
                            <div class="ranking-info">
                                <div class="ranking-name">${item.name}</div>
                                <div class="ranking-details">
                                    <span>${item.location}</span>
                                </div>
                            </div>
                            <div class="ranking-value">
                                <div class="ranking-amount">¥${item.amount.toLocaleString()}</div>
                            </div>
                        `;
                    }

                    container.appendChild(rankingItem);
                });
            }

            updateUserConsumptionRanking(userConsumptionData) {
                const container = document.getElementById('userConsumptionRanking');
                
                if (!container || !userConsumptionData) return;

                container.innerHTML = '';

                userConsumptionData.forEach((item, index) => {
                    const rankingItem = document.createElement('div');
                    rankingItem.className = 'ranking-item';

                    const rankClass = index < 3 ? `top-${index + 1}` : 'other';

                    rankingItem.innerHTML = `
                        <div class="ranking-number ${rankClass}">${index + 1}</div>
                        <div class="ranking-info">
                            <div class="ranking-name">${item.name}</div>
                            <div class="ranking-details">
                                <span>${item.region}</span>
                            </div>
                        </div>
                        <div class="ranking-value">
                            <div class="ranking-amount">¥${item.amount.toLocaleString()}</div>
                        </div>
                    `;

                    container.appendChild(rankingItem);
                });
            }

            bindEventListeners() {
                // 刷新按钮
                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => {
                        this.loadData();
                    });
                }

                // 时间范围筛选
                const timeRange = document.getElementById('timeRange');
                if (timeRange) {
                    timeRange.addEventListener('change', (e) => {
                        console.log('时间范围变更:', e.target.value);
                        this.loadData();
                    });
                }

                // 地域筛选
                const provinceSelect = document.getElementById('provinceSelect');
                const citySelect = document.getElementById('citySelect');
                const districtSelect = document.getElementById('districtSelect');

                if (provinceSelect) {
                    provinceSelect.addEventListener('change', (e) => {
                        console.log('省份变更:', e.target.value);
                        // 重置城市和区县选择
                        if (citySelect) {
                            citySelect.disabled = !e.target.value;
                            citySelect.selectedIndex = 0;
                        }
                        if (districtSelect) {
                            districtSelect.disabled = true;
                            districtSelect.selectedIndex = 0;
                        }
                        this.loadData();
                    });
                }

                if (citySelect) {
                    citySelect.addEventListener('change', (e) => {
                        console.log('城市变更:', e.target.value);
                        if (districtSelect) {
                            districtSelect.disabled = !e.target.value;
                            districtSelect.selectedIndex = 0;
                        }
                        this.loadData();
                    });
                }

                if (districtSelect) {
                    districtSelect.addEventListener('change', (e) => {
                        console.log('区县变更:', e.target.value);
                        this.loadData();
                    });
                }

                // 分红轮次展示（无需交互事件）

                // 地图控制按钮
                const mapControls = document.querySelectorAll('[data-map-type]');
                mapControls.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        mapControls.forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                    });
                });

                // 图表控制按钮
                const chartControls = document.querySelectorAll('[data-period]');
                chartControls.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const container = e.target.closest('.chart-container');
                        const controls = container.querySelectorAll('[data-period]');
                        const period = e.target.getAttribute('data-period');

                        controls.forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        // 更新图表数据
                        const chartId = container.querySelector('.chart').id;
                        if (this.chartManager && chartId) {
                            this.chartManager.updateChartPeriod(chartId, period);
                        }
                    });
                });
            }

            handleResize() {
                // 调整所有图表大小
                this.charts.forEach(chart => {
                    chart.resize();
                });
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM加载完成，开始初始化...');
            window.dashboard = new Dashboard();
            
            // 添加窗口resize事件监听
            window.addEventListener('resize', () => {
                if (window.dashboard) {
                    window.dashboard.handleResize();
                }
            });
        });
    </script>
</body>

</html>